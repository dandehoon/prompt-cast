<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manual Test - Popup</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      code {
        background-color: #f8f9fa;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
      }
    </style>
  </head>
  <body>
    <h1>Manual Test: Popup Effect Fix</h1>

    <div class="test-section info">
      <h2>Test Instructions</h2>
      <ol>
        <li>Make sure the extension is built with <code>pnpm dev</code></li>
        <li>
          Load the extension in Chrome from <code>.output/chrome-mv3-dev</code>
        </li>
        <li>Open the browser's Developer Tools (F12)</li>
        <li>Navigate to the Console tab</li>
        <li>Click on the extension icon in the toolbar to open the popup</li>
        <li>
          Check for any console errors, especially ones containing
          <code>effect_update_depth_exceeded</code>
        </li>
      </ol>
    </div>

    <div class="test-section">
      <h2>Expected Results</h2>
      <ul>
        <li>
          <strong>Success:</strong> Popup opens without any console errors
        </li>
        <li>
          <strong>Success:</strong> No messages containing
          "effect_update_depth_exceeded" or
          "https://svelte.dev/e/effect_update_depth_exceeded"
        </li>
        <li>
          <strong>Success:</strong> Popup functionality works (can type in the
          message input)
        </li>
      </ul>
    </div>

    <div class="test-section">
      <h2>What We Fixed</h2>
      <p>
        The issue was in <code>MessageSection.svelte</code> where we had a
        circular reactive binding:
      </p>
      <ol>
        <li>
          <code>Compose.svelte</code> was binding
          <code>messageState.inputRef</code> to <code>MessageSection</code>
        </li>
        <li>
          <code>MessageSection</code> had an effect that called
          <code>messageActions.setInputRef()</code> when the ref changed
        </li>
        <li>
          This created an infinite loop: binding → effect → store update →
          binding → effect...
        </li>
      </ol>

      <h3>Solution:</h3>
      <ul>
        <li>
          Removed the direct binding to the store in <code>Compose.svelte</code>
        </li>
        <li>Used a local <code>$state()</code> variable for the ref instead</li>
        <li>
          The effect in <code>MessageSection</code> now properly updates the
          store without creating a loop
        </li>
      </ul>
    </div>

    <div class="test-section">
      <h2>Manual Test Results</h2>
      <p><em>Record your test results here:</em></p>
      <div style="margin: 10px 0">
        <input type="checkbox" id="popup-opens" />
        <label for="popup-opens">Popup opens successfully</label>
      </div>
      <div style="margin: 10px 0">
        <input type="checkbox" id="no-console-errors" />
        <label for="no-console-errors">No console errors</label>
      </div>
      <div style="margin: 10px 0">
        <input type="checkbox" id="no-effect-errors" />
        <label for="no-effect-errors"
          >No effect_update_depth_exceeded errors</label
        >
      </div>
      <div style="margin: 10px 0">
        <input type="checkbox" id="input-works" />
        <label for="input-works">Message input field works</label>
      </div>
    </div>

    <script>
      console.log(
        'Manual test page loaded. Follow the instructions above to test the popup.',
      );
    </script>
  </body>
</html>
